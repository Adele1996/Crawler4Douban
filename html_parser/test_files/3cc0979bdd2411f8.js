
Do(function(){
  var popup;var nav=$("#db-global-nav");var more=nav.find(".bn-more");nav.delegate(".bn-more, .top-nav-reminder .lnk-remind","click",function(c){c.preventDefault();var a=$(this);var b=a.parent();if(popup){popup.parent().removeClass("more-active");if($.contains(b[0],popup[0])){popup=null;return}}b.addClass("more-active");popup=b.find(".more-items");popup.trigger("moreitem:show");return});$(document).click(function(a){if($(a.target).closest(".more-items").length||$(a.target).closest(".more-active").length){return}if(popup){popup.parent().removeClass("more-active");popup=null}});
});

    Do(function() {
      $.getScripts=function(){var b=Array.prototype.slice.call(arguments);if(!b.length){return}(function a(c){if(!c){return}if(typeof c=="function"){c();return}$.ajax({url:c,dataType:"script",cache:true,complete:function(){a(b.shift())}})})(b.shift())};
      $.getScripts(
        'http://img3.douban.com/js/lib/packed_jquery.tmpl.min9524192953.js',
        'http://img3.douban.com/f/movie/a197eee0a397e035a64abc25febc9b88c554f5c4/js/movie/search_sugg.js',
        function() {
         $("#db-nav-movie").find("input[name=search_text]").iSuggest({
             api: '/j/subject_suggest',
             tmplId: 'suggResult',
             item_act: function(item){
                 window.location = item.data("link");
             }
         });
      });
    });
  
Do(function(){
  var nav = $('#db-nav-movie');
  var inp=$("#inp-query"),label=inp.closest(".nav-search").find("label");if(inp.val()!==""){label.hide()}inp.parent().click(function(){inp.focus();label.hide()}).end().focusin(function(){label.hide()}).focusout(function(){if($.trim(this.value)===""){label.show()}else{label.hide()}}).keydown(function(){label.hide()});inp.parents("form").submit(function(){if(!$.trim(inp.val()).length){return false}});nav.find(".lnk-more, .lnk-account").click(function(b){b.preventDefault();var d,a=$(this),c=a.hasClass("lnk-more")?$("#db-productions"):$("#db-usr-setting");if(!c.data("init")){d=a.offset();c.css({"margin-left":(d.left-$(window).width()/2-c.width()+a.width()+parseInt(a.css("padding-right"),10))+"px",left:"50%",top:d.top+a.height()+"px"});c.data("init",1);c.hide();$("body").click(function(g){var f=$(g.target);if(f.hasClass("lnk-more")||f.hasClass("lnk-account")||f.closest("#db-usr-setting").length||f.closest("#db-productions").length){return}c.hide()})}if(c.css("display")==="none"){$(".dropdown").hide();c.show()}else{$(".dropdown").hide()}});
});

    function deferred(){var a={done:[],fail:[]};var b={done:function(c){a.done.push(c);return b},fail:function(c){a.fail.push(c);return b}};return{resolve:function(){var d=0,c;for(;c=a.done[d++];){c.apply(this,arguments)}},reject:function(){var d=0,c;for(;c=a.fail[d++];){c.apply(this,arguments)}},promise:b}}var loader=function(b,h,d,e,i,a){if(!b){return}if(typeof h==="function"){e=h;h=""}if(typeof d==="function"){e=d;d=""}var f=function(){loader.loaded[b]=1;e&&e(b);e=null;clearTimeout(g)};if(loader.loaded[b]){if(loader.loading[b]){loader.loading[b]=0}setTimeout(function(){f()},0);return}if(loader.loading[b]){setTimeout(function(){loader(b,h,d,e,i,a)},10);return}loader.loading[b]=1;var g=setTimeout(function(){if(timeoutCallback){try{timeoutCallback(b)}catch(l){}}},i||6000);var k=h||b.toLowerCase().split(/\./).pop().replace(/[\?#].*/,"");var c;if(k==="js"){c=document.createElement("script");c.setAttribute("type","text/javascript");c.setAttribute("src",b);c.setAttribute("async",true)}else{if(k==="css"){c=document.createElement("link");c.setAttribute("type","text/css");c.setAttribute("rel","stylesheet");c.setAttribute("href",b)}}if(d){c.charset=d}if(k==="css"){setTimeout(function(){f()},0)}else{c.onerror=function(){f();c.onerror=null};c.onload=c.onreadystatechange=function(){var l;if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){setTimeout(function(){f()},0);c.onload=c.onreadystatechange=null}}}var j=(function(){var l=document.getElementsByTagName("script");return l[l.length-1]})();j.parentNode.insertBefore(c,j)};loader.loaded={};loader.loading={};loader.batch=function(e){if(!e){return}var f=deferred();var a=[];var d=function(){a.pop();if(a.length===0){f.resolve()}};for(var c=0,b;b=e[c++];){a.push(b);loader(b,d)}return f.promise};
    Do(function() {
      loader.batch([
        'http://img3.douban.com/css/ui/packed_dialog7156407994.css',
        'http://img3.douban.com/js/ui/packed_dialog2496676458.js'
      ]).done(function() {
        var encodeHTML=function(a){return a.replace(/\&/g,"&amp;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")};function deferred(){var a={done:[],fail:[]};var b={done:function(c){a.done.push(c);return b},fail:function(c){a.fail.push(c);return b}};return{resolve:function(){var d=0,c;for(;c=a.done[d++];){c.apply(this,arguments)}},reject:function(){var d=0,c;for(;c=a.fail[d++];){c.apply(this,arguments)}},promise:b}}function asyncRequest(a,d,e){var c=deferred();var b=(e||"get").toLowerCase();$.ajax({url:a,type:b,dataType:"json",data:(b==="post")?$.extend(d,{ck:get_cookie("ck")}):d,error:function(f){c.reject(f)},success:function(f){c.resolve(f)}});return c.promise}var DOULIST_ADDITEM="/j/doulist/{doulist_id}/additem";var DOULIST_EDITITEM="/j/doulist/{doulist_id}/edititem";var DOULIST_COMMENT="/j/doulist/{doulist_id}/poke";var DOULIST_CREATE="/j/doulist/add";var DOULIST_LIST="/j/doulist/cat";var DOULIST_SEARCH="/j/doulist/search";var validateForm=function(c,d){var a=true;var b;for(var e in d){if(d.hasOwnProperty(e)){b=c.find(e);a=d[e](b);if(a){validateForm.cleanError(b)}}}return a};validateForm.displayError=function(c,a){if(!c){return}var b=c.closest(".item");var d=b.find(".form-field-error");if(d.length===0){d=$('<div class="form-field-error"></div>').appendTo(b)}d.show().html(a)};validateForm.cleanError=function(a){a.closest(".item").find(".form-field-error").hide()};function doulistCustomeEvents(a){var b=a.node.find(".bn-cancel");a.node.bind("dialog-error",function(d,c){a.setContent('<div class="doulist-submit-success"><p>'+c+'</p>         <div class="item-submit">           <span class="bn-flat"><input type="button" value="关闭" class="bn-cancel"></span>         </div>       </div>      ').update();b.click(function(){a.close()});setTimeout(function(){a.close()},3000)});a.node.bind("dialog-success",function(h,c){a.setTitle("添加成功").setContent('<div class="doulist-submit-success">         <i></i>已经添加到<a href="'+c.url+'" target="_blank">'+c.name+'</a>         <div>           <p>窗口将在<b class="num">3</b>秒后关闭</p>           <span class="bn-flat"><input type="button" value="关闭" class="bn-cancel"></span>         </div>       </div>      ');b=a.node.find(".bn-cancel");b.click(function(){a.close();i&&clearTimeout(i)});var d=a.node.find(".num"),g=d.text(),f,i;(function(){f=f||arguments.callee;i=setTimeout(function(){d.text(--g);g?f():a.close()},1000)})()})}var doulistDialogForm=typeof doulistDialogForm==="undefined"?{}:doulistDialogForm;(function(){var d=function(e){var f=e.node.find("form");f.submit(function(g){g.preventDefault();var h={choice:f.find('[name="dl_choose"]:checked').val(),subjectId:f.find("input[name=subject_id]").val(),comment:f.find('textarea[name="comment"]').val(),sync:f.find("#dlg-opt-share").attr("checked")?"1":""};a[h.choice](e,f,h).bind("form-submit-error",function(j,i){e.node.trigger("dialog-error",i)}).bind("form-submit-success",function(j,i){e.node.trigger("dialog-success",i)})});f.bind("form-submit-fail",function(g,h){validateForm.displayError(f.find("input[name=dl_title]"),h)});doulistCustomeEvents(e)};var a={dl_new:c,dl_exist:b};function c(e,g,h){var f={"input[name=dl_title]":function(i){if(i.val()===""){validateForm.displayError(i,"请给你的列表起一个名称");return false}return true}};if(validateForm(g,f)){asyncRequest(DOULIST_CREATE,{title:g.find("input[name=dl_title]").val(),cat:g.find("input[name=dl_cat]").val(),sid:h.subjectId,comment:h.comment,sync_to_mb:h.sync},"post").done(function(i){if(i.r){g.trigger("form-submit-fail",i.err);return}i.sid=h.subjectId;i.doulist_id=i.id;i.name=encodeHTML(i.name);g.trigger("form-submit-success",i)})}else{e.update()}return g}function b(f,g,h){var e=g.find("select[name=dl_id] option:selected");asyncRequest(DOULIST_ADDITEM.replace("{doulist_id}",e.val()),{sid:h.subjectId,comment:h.comment,sync_to_mb:h.sync},"post").done(function(i){if(i.r){g.trigger("form-submit-error",i.err);return}i.sid=h.subjectId;i.doulist_id=e.val();i.name=$.trim(encodeHTML(e.text()));g.trigger("form-submit-success",i)});return g}doulistDialogForm.initForm=d})();$(document).delegate(".lnk-doulist-add","click",function(b){b.preventDefault();var a=$(this);if(!a.data("clicked")){var c=$.extend($(this).data(),{link:this.href});var d={};for(key in c){if(c.hasOwnProperty(key)){d[$.camelCase(key)]=c[key]}}showDoulistDialog(d);getExistDoulist(current_doulist_dialog,d,a);doulistDialogForm.initForm(current_doulist_dialog);a.data("clicked",true)}});var current_doulist_dialog;function showDoulistDialog(a){if(current_doulist_dialog){current_doulist_dialog.close()}var b=current_doulist_dialog=dui.Dialog({title:"添加到"+a.catename+"豆列",width:500,content:('<form action="" method="get">        <div class="doulist-bd">        <div class="item">          <label>选择豆列</label>          <div class="dl-bd">            <div class="dl-item">              <label for="dl_new"><input type="radio" name="dl_choose" id="dl_new" value="dl_new" checked />新建豆列</label><div class="dl_new_title"><input name="dl_title" id="dl_title" type="text" class="basic-input" placeholder="输入新豆列名称" ></div>            </div>          </div>        </div>        <div class="item">          <label>添加评语<br/><span>（选填）</span></label>          <textarea id="doulist_item_comment" class="basic-textarea" name="comment"></textarea>        </div>        <input type="hidden" name="dl_cat" value="{{cate}}">        <input type="hidden" name="subject_id" value="{{id}}">       </div>       <div class="doulist-ft">         <span class="bn-flat"><input type="submit" value="保存"></span>       </div>     </form>      ').replace(/{{[^{}]+}}/g,function(c){return a[c.replace(/[{}]/g,"")]})},true).open();b.update();b.node.bind("dialog:close",function(){b.node.remove()});b.node.bind("dialog:change",function(){b.update()}).addClass("dialog-doulist")}function getExistDoulist(b,a,c){asyncRequest(DOULIST_LIST,{cat:a.cate,sid:a.id}).done(function(f){if(f.r||f.doulist.length===0){b.update();return}var d='<option value="{{id}}">{{name}}</option>';var g='<label for="dl_exist" class="label_dl_exist"><input type="radio" name="dl_choose" id="dl_exist" value="dl_exist" checked>已有豆列</label><div class="dl_exist_select"><select class="dl_id" id="dl_id" name="dl_id"></div>';$(f.doulist).each(function(h,e){g+=d.replace(/{{[^{}]+}}/g,function(i){return encodeHTML(e[i.replace(/[{}]/g,"")])})});g+="</select>";b.node.find("#dl_new").removeAttr("checked");$("<div />",{"class":"dl-item dl-item-exist"}).insertBefore($(".dl-item")).html(g);$(".dl_new_title").hide();b.node.find("form #doulist_item_comment").val(f.comment);b.update();handleDoulist(a);c.data("clicked",false)}).fail(function(){b.update();c.data("clicked",false)})}function handleDoulist(a){var b=current_doulist_dialog;var e=$("#dl_new");var g=$(".dl_new_title");var d=$(".form-field-error");var f=$("#dl_title");var c=$("#dl_id");b.node.find('[name="dl_choose"]').bind("change",function(){var h=$(".form-field-error");e.attr("checked")?(g.show()&&h.show()&&f.focus()&&c.addClass("dl_id_disable")):g.hide()&&h.hide()&&c.removeClass("dl_id_disable");b.update()});b.node.find("form select").change(function(){var i=$(this).val();var h=DOULIST_COMMENT.replace("{doulist_id}",i);asyncRequest(h,{sid:a.id}).done(function(j){b.node.find("form #doulist_item_comment").val(j.comment)}).fail(function(){})})};
      });
    });
  
                $(document).ready(function(){$(".btn-unfold").bind("click",function(c){c.preventDefault();var b=$(c.target),a=b.parent(".fold-hd");a.slideUp().next().slideDown()});$("#comments-section").delegate(".tab-hd a","click",function(b){b.preventDefault();var a=$(b.target);$("#comments-section").find(".tab-hd a").removeClass("on").end().find(".tab").hide().end().find("#"+a.data("id")+"-comments").show();a.addClass("on");$.get("/blank?track-"+a.attr("id"));return false})});
            
    $(document).ready(function(){$(".btn-unfold").bind("click",function(c){c.preventDefault();var b=$(c.target),a=b.parent(".fold-hd");a.slideUp().next().slideDown()})});
    Douban.init_unfolder=function(a){$(a).click(function(){var e=a.id.split("-")[1];var b=a.rel.split("-")[1];var c="/j/review/"+e+"/full";function d(){$("#review_"+e+"_short").hide();$("#review_"+e+"_full").show();$("#af-"+e).hide();$("#au-"+e).show()}if($("#review_"+e+"_full_content:empty").length){$.getJSON(c,{show_works:b},function(f){var g=document.createElement("div");g.innerHTML=f.html;$("#review_"+e+"_full_content").append(g);$("#ucount"+e+"u").text(f.votes.usecount);$("#ucount"+e+"l").text(f.votes.totalcount-f.votes.usecount);$("#"+e+"_short_useful").text(f.votes.usecount+"/"+f.votes.totalcount);d()})}else{d()}return false})};Douban.init_folder=function(a){$(a).click(function(){var b=$(a).attr("id").split("-")[1];$("#review_"+b+"_full").hide();$("#review_"+b+"_short").show();$(a).hide();$("#af-"+b).show()})};var warn_secret=function(rid){url="/j/review/"+rid+"/warn_secret";$.post_withck(url,{},function(sjson){var ret=eval("("+sjson+")");if(ret.result){$("#secret_"+rid).html("");$("#warn_ticket_"+rid).html('<span class="m">剧透提醒已经提交，谢谢。</span>')}})};var voteuse_act=function(a,e,d,c){var b="/j/"+d+"/"+e+(a?"/useful":"/useless");$.postJSON_withck(b,{},function(h){if(h.result){if(c){var g=$("#ucount"+e+"u"),f=$("#ucount"+e+"l");if((g.text()==h.usecount)&&(f.text()==h.totalcount-h.usecount)&&(h.result!="notself")){alert("你已经投过票了")}g.html(h.usecount);f.html(h.totalcount-h.usecount);$("#"+e+"_short_useful").text(h.usecount+"/"+h.totalcount)}else{$("#voteuse_"+e).html('<span class="m gtleft">你的投票已经提交，谢谢。</span>');$("#userate_"+e).html('<p id="userate_%s" class="pl">'+h.usecount+"/"+h.totalcount+"的人觉得此评论有用:</p>")}}return false})};

    $(document).ready(function(){$(".btn-unfold").bind("click",function(c){c.preventDefault();var b=$(c.target),a=b.parent(".fold-hd");a.slideUp().next().slideDown()})});

        (function(j,o,r){var q="hashchange",l=document,n,m=j.event.special,k=l.documentMode,p="on"+q in o&&(k===r||k>7);function s(a){a=a||location.href;return"#"+a.replace(/^[^#]*#?(.*)$/,"$1")}j.fn[q]=function(a){return a?this.bind(q,a):this.trigger(q)};j.fn[q].delay=50;m[q]=j.extend(m[q],{setup:function(){if(p){return false}j(n.start)},teardown:function(){if(p){return false}j(n.stop)}});n=(function(){var d={},e,a=s(),c=function(h){return h},b=c,f=c;d.start=function(){e||g()};d.stop=function(){e&&clearTimeout(e);e=r};function g(){var h=s(),i=f(a);if(h!==a){b(a=h,i);j(o).trigger(q)}else{if(i!==a){location.href=location.href.replace(/#.*/,"")+i}}e=setTimeout(g,j.fn[q].delay)}j.browser.msie&&!p&&(function(){var i,h;d.start=function(){if(!i){h=j.fn[q].src;h=h&&h+s();i=j('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){h||b(s());g()}).attr("src",h||"javascript:0").insertAfter("body")[0].contentWindow;l.onpropertychange=function(){try{if(event.propertyName==="title"){i.document.title=l.title}}catch(t){}}}};d.stop=c;f=function(){return s(i.location.href)};b=function(w,z){var x=i.document,y=j.fn[q].domain;if(w!==z){x.title=l.title;x.open();y&&x.write('<script>document.domain="'+y+'"<\/script>');x.close();i.location.hash=w}}})();return d})()})(jQuery,this);
        $(function(){
            $("#season").live('change', function(){
            var subjectId = $(this).val();
            if (subjectId.length){
                    window.location = "/subject/" + subjectId + "/";
                }
            });

            $(window).hashchange();
            if(window.location.href.indexOf('suggest')>0 && window.location.href.indexOf("?")>0){
                if(window.history.pushState){
                    window.history.pushState(null, document.title,  window.location.href.substring(0,window.location.href.indexOf("?")));
                }
            }

            $('.indent .a_show_full').click(function(){
                $.get('/blank?expand');
            });
        });
    